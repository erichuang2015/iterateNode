<!DOCTYPE html>
<html>
<head>
    <title>IterateNode Example</title>
    <link href="../src/css/iterateNode.css" rel="stylesheet" />
    <style>
        body{
            font-size:16px;
            overflow-x:hidden;
        }
    </style>
    <!-- some comments
    and comments...
    and comments...
    -->
</head>
<body>

    <button onclick="action('anlyzJson')">Analyze Json</button>
    <button onclick="action('anlyzDocument')">Analyze documentElement</button>
    <button onclick="action('anlyzDocumentFiltered')">Analyze document body - Filtered</button>
    <button onclick="action('imadiv')">Analyze imadiv</button>
    <label>
        <span>Load a file:</span>
        <input type="file" id="inputFiles">
    </label>
    <div id="imadiv">
        imadiv
        <p>
            <b>imadiv<span>imadiv</span></b>
        </p>
    </div>
    <!-- some comments -->
    <pre id="parseJs">

    </pre>
    <script src="../src/js/createCaret.js"></script>
    <script src="../src/js/parsingNode.js"></script>
    <script src="../src/js/iterateNode-documentFragment.js"></script>
    <script src="../src/js/sanitize.js"></script>
    <script src="../src/js/merge.js"></script>
    <script src="../src/js/assignParamFromString.js"></script>
    <script>
        var parseJsObject = document.getElementById("parseJs");
        function action(type){
            switch(type){
                case "anlyzJson":
                    var xmlhttp = new XMLHttpRequest();
                    xmlhttp.onreadystatechange = function() {
                        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                            var myJSONObject = JSON.parse(xmlhttp.responseText);
                            var iterateNodeSettings = {};
                            iterateNodeSettings.obj = myJSONObject;
                            iterateNodeSettings.flatArrays = true;
                            var parseJs = iterateNode(iterateNodeSettings);
                            parseJsObject.innerHTML = "";
                            parseJsObject.appendChild(parseJs);
                        }
                    };
                    xmlhttp.open("GET", "./JSON/example.json", true);
                    try {
                        xmlhttp.send();
                    }
                    catch(e){
                        alert("there seems to be a problem in REST connection ( maybe this page is not served by a Server? ) " +
                        "Try to load a file instead.")
                    }
                    break;
                case "anlyzDocument":
                    var iterateNodeSettings = {};
                    iterateNodeSettings.obj = document;
                    var parseJs = iterateNode(iterateNodeSettings);
                    parseJsObject.innerHTML = "";
                    parseJsObject.appendChild(parseJs);
                    break;
                case "anlyzDocumentFiltered":
                    var filterFunction = function(obj){
                        var target = {};
                        var DOMtype = obj.tagName || obj.nodeName;
                        var text = obj.nodeValue;
                        var typeNode = Object.prototype.toString.call(obj);
                        var iterateChildNodes = function(childNode){
                            target = [];
                            if ( !childNode.length )
                                return {};

                            for(var k = 0; k < childNode.length; k++)
                            {
                                if( !childNode[k].nodeValue || childNode[k].nodeValue.trim() )
                                    target.push(childNode[k]);
                                else if ( !childNode[k].tagName && childNode[k].nodeValue.trim() )
                                    target.push({ innerText : childNode[k].nodeValue });
                            }
                            return target;
                        };
                        if ( typeNode == "[object NodeList]" && !text )
                            return iterateChildNodes(obj);

                        if ( text )
                            return{ innerText : text };

                        return iterateChildNodes(obj.childNodes);
                    };
                    var typeOfFilter = function(str,obj){
                        var DOMtype = obj.tagName || obj.nodeName;
                        var attributes = "";
                        if ( obj.attributes )
                            for(var i = 0; i<obj.attributes.length;i++)
                                attributes += " " + obj.attributes[i].nodeName + "=&quot;" + obj.attributes[i].nodeValue + "&quot;";

                        var returnString = "&lt;" + DOMtype + attributes + "&gt;";
                        return returnString;
                    };
                    var iterateNodeSettings = {};
                    iterateNodeSettings.obj = document.documentElement;
                    iterateNodeSettings.filterFunction = filterFunction;
                    iterateNodeSettings.typeOfFilter = typeOfFilter;
                    iterateNodeSettings.flatArrays = function(obj){
                        return obj.childNodes;
                    };
                    var parseJs = iterateNode(iterateNodeSettings);
                    parseJsObject.innerHTML = "";
                    parseJsObject.appendChild(parseJs);
                    break;
                case "imadiv":
                    var iterateNodeSettings = {};
                    iterateNodeSettings.obj = document.getElementById("imadiv");
                    var parseJs = iterateNode(iterateNodeSettings);
                    parseJsObject.innerHTML = "";
                    parseJsObject.appendChild(parseJs);
                default:
                    break;
            }
        }
        var inputElement = document.getElementById("inputFiles");
        inputElement.addEventListener("change", handleFiles, false);
        function handleFiles() {
            var fileList = this.files;
            var reader = new FileReader();
            reader.onload = function(res){
                try{
                    var json = JSON.parse(res.target.result);
                    var iterateNodeSettings = {};
                    iterateNodeSettings.obj = json;
                    var parseJs = iterateNode(iterateNodeSettings);
                    parseJsObject.innerHTML = "";
                    parseJsObject.appendChild(parseJs);
                }
                catch(e){
                    alert("The file selected doesn't not appear to be a JSON")
                }
            };
            reader.readAsText(fileList[0]);
        }
    </script>
</body>
</html>